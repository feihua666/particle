import{b as A,e as S,f as q}from"./openplatformOpenapiCompItem-BPC3Zf7h.js";import{a as E}from"./openplatformAppCompItem-C0DjwN5v.js";import{e as w,a as G,d as D}from"./FileTools-Cx4MUywI.js";import{d as M,r as f,a as W,b as r,o as O,c as F,e as l,w as c,f as K,E as L,F as j,G as z,ar as H,as as J,at as C,au as X}from"./index-D8BtRcSm.js";import{t as Y,d as Z}from"./openplatformOpenapiBatchQueryRecordAdminApi-Brh_7bO0.js";import"./openplatformAppAdminApi-3QenI2ux.js";import"./crmCompItem-DsX0QlD0.js";import"./crmCustomerTagAdminApi-CDprfrs5.js";const $={key:0},ie=M({__name:"OpenplatformOpenapiBatchDataQueryPage",setup(ee){let _=(e,t="success")=>{z({showClose:!0,message:e,type:t,showIcon:!0,grouping:!0})};const b=f(null),p=f(null),a=W({form:{},formComps:[E({label:"应用",required:!0,valueChange:({form:e,newValue:t})=>{t||(e.openplatformOpenapiId=null)},tips:" 1. 请先选择要使用的应用"}),A({fieldName:"openplatformOpenapiId",label:"开放接口",required:!0,disableGroup:!0,valueChange:({form:e,newValue:t})=>{},tips:" 2. 请选择要查询的接口"})],templateform:{},templateformComps:[{field:{name:"file",value:[]},element:{comp:"PtUpload",formItemProps:{label:"查询文件",required:!0,displayBlock:!0},compProps:{drag:!0,autoUpload:!1,limit:1,dragTip:"将文件拖到此处或<em>点击上传</em>",tipTxt:"只能上传一个文件，请严格按照下载的模板进行填写，并保证第一个sheet为查询参数",onExceed:(e,t)=>{_("最多只能选择一个文件,如要重新选择，请先删除之前的文件","error")}}}},{field:{name:"remark"},element:{comp:"el-input",formItemProps:{label:"备注",required:!0,displayBlock:!0},compProps:{clearable:!0}}}],openplatformOpenapiBatchQueryRecordId:null,tableColumns:Y,tableData:[]}),d=f({buttonText:"查询",loading:!1,permission:"admin:web:openplatformOpenapi:batchQuery"}),P=()=>{x(()=>{R(()=>{d.value.loading=!0,I().then(e=>{let t=e.data.data;a.openplatformOpenapiBatchQueryRecordId=t.id,k(a.openplatformOpenapiBatchQueryRecordId),_("查询成功,您可在当前页面刷新结果状态或稍候前往批量查询记录查看结果")}).finally(()=>{d.value.loading=!1})})}),R(()=>{})},x=e=>{b.value&&b.value.formRef.validate((t,o)=>{t&&e()})},R=e=>{p.value&&p.value.formRef.validate((t,o)=>{t&&e()})},I=()=>{let e=new FormData;for(let t in a.form)e.append(t,a.form[t]);return e.append("file",a.templateform.file[0].raw),e.append("remark",a.templateform.remark),q(e)},T=()=>{p.value&&p.value.resetForm()},h=f(!1),Q=()=>{x(()=>{h.value=!0;let e={};for(let t in a.form)e[t]=a.form[t];S(e).then(t=>{let o=t.data,m=w(t),n=G(t);n=decodeURIComponent(n),D(o,m,n)}).finally(()=>{h.value=!1})})},k=e=>{C(a.tableData),g(e).then(t=>{a.tableData=[t.data.data]})},N=e=>g(e).then(t=>{for(let o=0;o<a.tableData.length;o++)a.tableData[o].id==e&&X(a.tableData,o,t.data.data);return Promise.resolve(t)}),g=e=>Z({id:e}),U=({row:e,column:t,$index:o})=>{if(o<0)return[];e.id;let m={openplatformOpenapiBatchQueryRecordId:e.id};return[{txt:"刷新",text:!0,method(){return N(a.openplatformOpenapiBatchQueryRecordId)}},{txt:"下载",text:!0,disabled:e.executeStatusDictValue!="finished",disabledReason:e.executeStatusDictValue!="finished"?"执行完成后才可能下载":void 0,method(){let i=H(e.exportFileUrl),y=i.substring(i.lastIndexOf("/")+1);return J(i).then(u=>{let B=u.data,s=w(u),v=decodeURIComponent(y);return D(B,s,v),Promise.resolve(u)})}},{txt:"查看详情",text:!0,position:"more",permission:"admin:web:openplatformOpenapiBatchQueryRecordDetail:pageQuery",route:{path:"/admin/openplatformOpenapiBatchQueryRecordDetail1",query:m}},{txt:"删除",text:!0,position:"more",methodConfirmText:"确定要删除当前数据吗？删除后您可以前往批量查询记录查看结果",method(){a.openplatformOpenapiBatchQueryRecordId=null,C(a.tableData)}}]};return(e,t)=>{const o=r("PtForm"),m=r("PtButton"),n=r("PtButtonGroup"),i=r("el-table-column"),y=r("PtTable"),u=r("el-alert"),B=r("PtRouteViewPopover");return O(),F(j,null,[l(o,{ref_key:"formRef",ref:b,form:a.form,labelWidth:"120",defaultButtonsShow:"",inline:"",layout:2,comps:a.formComps},null,8,["form","comps"]),l(o,{ref_key:"templateFormRef",ref:p,form:a.templateform,labelWidth:"120",defaultButtonsShow:"",inline:"",layout:1,comps:a.templateformComps},null,8,["form","comps"]),l(o,{form:[],labelWidth:"120",method:P,defaultButtonsShow:"submit,reset",submitAttrs:d.value,inline:"",showButtonItem:!0,onResetForm:T,comps:[]},{buttons:c(()=>[l(m,{permission:"admin:web:openplatformOpenapi:batchQuery",loading:h.value,method:Q},{default:c(()=>t[1]||(t[1]=[K("下载模板")])),_:1},8,["loading"])]),_:1},8,["submitAttrs"]),a.openplatformOpenapiBatchQueryRecordId?(O(),F("div",$,[l(y,{ref:"tableRef","default-expand-all":"",data:a.tableData,onDataMethodDataLoading:t[0]||(t[0]=s=>d.value.loading=s),columns:a.tableColumns},{defaultAppend:c(()=>[l(i,{label:"操作",width:"220"},{default:c(({row:s,column:v,$index:V})=>[l(n,{options:U({row:s,column:v,$index:V}),dropdownTriggerButtonOptions:{text:!0,buttonText:"更多"}},null,8,["options"])]),_:1})]),_:1},8,["data","columns"]),l(u,{title:"注意：以上表格仅展示最后一次查询的查询结果",type:"info",style:{width:"350px","margin-top":"10px"}})])):L("",!0),l(B,{level:3})],64)}}});export{ie as default};
