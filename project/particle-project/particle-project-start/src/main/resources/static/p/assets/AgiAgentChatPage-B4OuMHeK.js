import{aL as bt,aM as Tt,aN as Y,aO as wt,k as tt,d as dt,r as g,a as kt,b as _,o as A,c as I,e as r,w as d,F as Z,aP as Pt,$ as Mt,j as c,g as X,f as k,G as J,I as N,D as Nt,aQ as It,m as O,av as St,B as Bt,S as ct,aR as Dt,ad as Ht,_ as Lt}from"./index-DMP92Tz2.js";import{p as Ut,a as Vt,r as $t}from"./agiAgentChatFrontApi-i_f8CfxT.js";function Rt(){const i=new bt(Tt({emptyLangClass:"",langPrefix:"language-",highlight(m,l,y){return l&&Y.languages[l]&&(m=Y.highlight(m,Y.languages[l],l)),m}})),u=new i.Renderer,D=u.code;return u.code=function({text:m,lang:l,escaped:y}){let C=D({text:m,lang:l,escaped:y});return C=C.replace("<pre><code",'<pre class="language-'+l+'"><code'),`
            <div class="pt-chat-code-container">
                <div class="pt-chat-code-container-header">
                    <div class="pt-chat-code-container-header-content pt-height-100-pc pt-flex-align-between pt-flex-item-1 pt-flex-align-cross-center">
                        <div class="pt-chat-code-container-header-content-left">
                            <div class="pt-chat-code-container-header-content-left-lang">${l||""}</div>
                        </div>
                        <div class="pt-chat-code-container-header-content-right">
                            <div class="pt-chat-code-container-header-content-right-copy pt-pointer">复制</div>
                        </div>
                    </div>
                </div>
                <div class="pt-chat-code">${C}</div>
                <div class="pt-chat-code-container-footer">
                    <div class="pt-chat-code-container-footer-content pt-height-100-pc pt-flex-align-between pt-flex-item-1 pt-flex-align-cross-center">
                        <div class="pt-chat-code-container-footer-content-left">
                            <div class="pt-chat-code-container-footer-content-left-lang">${l||""}</div>
                        </div>
                        <div class="pt-chat-code-container-footer-content-right">
                            <div class="pt-chat-code-container-footer-content-right-copy pt-pointer">复制</div>
                        </div>
                    </div>
                </div>
            </div>
            `},i.use({renderer:u}),i}function Et(i,u){const D=i.parse(u);return wt.sanitize(D)}let ut="/front/web/agi_agent";const Jt=i=>tt.get(ut+"/detail",{params:i}),Ot=i=>tt.post(ut+"/chatStream",i,{adapter:["fetch","xhr","http"],responseType:"stream"});let qt="/front/web/agi_agent_chat_message";const Ft=i=>tt.get(qt+"/page",{params:i}),jt=dt({__name:"AgiAgentChatHistory",props:{agiAgentId:{type:String}},setup(i){const u=g(null),m=kt({form:{agiAgentId:i.agiAgentId,orderBy:"createAt-0"},formComps:Ut,tableColumns:[{prop:"title",label:"对话标题"},{prop:"titleMemo",label:"对话标题说明"},{prop:"createAt",label:"创建时间"}]}),l=g({buttonText:"查询",loading:!1,permission:"front:web:agiAgentChat:pageQuery"}),y=()=>{u.value.refreshData()},C=({pageQuery:h})=>Vt({...m.form,...h}),P={permission:l.value.permission},H=({row:h,column:L,$index:U})=>U<0?[]:[{txt:"编辑",text:!0,permission:"front:web:agiAgentChat:update",route:{path:"/front/agiAgentChatUpdate",query:{id:h.id}}},{txt:"删除",text:!0,permission:"front:web:agiAgentChat:delete",methodConfirmText:`确定要删除 ${h.title} 吗？`,method(){return $t({id:h.id}).then(T=>(y(),Promise.resolve(T)))}}];return(h,L)=>{const U=_("PtForm"),o=_("PtButtonGroup"),V=_("el-table-column"),T=_("PtTable");return A(),I(Z,null,[r(U,{form:m.form,method:y,defaultButtonsShow:"submit,reset",submitAttrs:l.value,inline:"",comps:m.formComps},null,8,["form","submitAttrs","comps"]),r(T,{ref_key:"tableRef",ref:u,"default-expand-all":"",dataMethod:C,onDataMethodDataLoading:L[0]||(L[0]=w=>l.value.loading=w),paginationProps:P,columns:m.tableColumns},{defaultAppend:d(()=>[r(V,{label:"操作",width:"180"},{default:d(({row:w,column:q,$index:S})=>[r(o,{options:H({row:w,column:q,$index:S})},null,8,["options"])]),_:1})]),_:1},8,["columns"])],64)}}}),Gt={class:"pt-chat-message-header pt-flex-align-between pt-width-100-pc"},Wt={class:"pt-chat-message-header-left"},zt={class:"pt-flex-align-cross-center"},Qt={style:{"margin-left":"0.8rem"}},Xt={class:"pt-chat-message-header-right"},Kt={class:"pt-chat-message-header-right-history"},Yt={class:"pt-chat-message-container pt-width-100-pc"},Zt={class:"pt-chat-message-list pt-flex-direction-c"},te={class:"pt-chat-message-item"},ee={class:"pt-chat-message-item-content-avatar"},ae=["textContent"],se={key:1,class:"pt-chat-message-item-content-message"},ne={class:"pt-chat-action-container pt-width-100-pc"},oe={key:0,class:"pt-chat-action-container-action-upload-container"},re={class:"pt-chat-action-container-action pt-flex-align-between pt-flex-align-end"},ie={class:"pt-chat-action-container-action-right pt-flex-align-cross-center"},le=dt({__name:"AgiAgentChatPage",props:{agiAgentId:{type:String},chatId:{type:String}},setup(i){const u=Pt(),{proxy:D,appContext:m}=Bt(),l=m.config.globalProperties.$router,y=i,C=g(null),P=g(0);let H=!1;const h=(e=!1)=>{let t=C.value.$el;if(e){if(H)return;H=!0,t.scrollTo({top:t.scrollHeight-t.clientHeight,behavior:"smooth"}),P.value=t.scrollHeight-t.clientHeight,H=!1}else U()?P.value=t.scrollHeight-t.clientHeight:L()&&(h(!0),B.value&&requestAnimationFrame(()=>{h(e)}))},L=()=>C.value.$el.scrollTop>=P.value,U=()=>C.value.$el.scrollTop<P.value,o=g(null),V=g(null),T=g(!1),w=g(!1),q=g(!1),S=g(!1),M=g(""),pt=Rt(),et=e=>Et(pt,e),K=g(""),F=g([]),j=(e,t)=>{let n={messageType:e,content:e!="user"?et(t):t};return F.value.push(n),F.value[F.value.length-1]},gt=e=>j("user",e),at=e=>j("assistant",e),mt=e=>{if(!e){T.value=!0,G();return}Jt({id:e}).then(t=>{T.value=!0,o.value=t.data,G()}).finally(()=>{T.value=!0})},ht=e=>{if(!e){w.value=!0,G();return}Ft({chatId:e,orderBy:"createAt-0"}).then(t=>{w.value=!0,V.value=t.data,G()}).finally(()=>{w.value=!0})},G=()=>{if(!q.value&&T.value&&w.value){let e=V.value.data.reverse(),t=o.value.data;if(e&&e.length>0)for(let n=0;n<e.length;n++)j(e[n].messageType,e[n].content);else if(t){t.isUsePrologue&&t.prologue&&at(t.prologue);let n=t.presetDialogueJson;if(n){let s=JSON.parse(n).messages;if(s&&s.length>0)for(let p=0;p<s.length;p++)j(s[p].messageType,s[p].text)}}q.value=!0,ct(()=>{h(!0)})}},ft=()=>{st()},B=g(!1),vt=new TextDecoder("utf-8"),st=()=>{if(B.value||!M.value)return;let e={agiAgentId:y.agiAgentId,chatId:y.chatId,message:M.value};gt(M.value);let t=at("");K.value="",B.value=!0,ct(()=>{setTimeout(()=>{h(!0)})}),M.value="",Ot(e).then(n=>{const a=n.data.getReader();a.read().then(function s({done:p,value:f}){if(p){B.value=!1,nt(t,f),h();return}nt(t,f),h(),a.read().then(s)})}).catch(n=>{B.value=!1})},nt=(e,t)=>{let a=vt.decode(t).replace("data:","");if(a){a=a.trim();let s=null;try{a.startsWith("{")&&a.endsWith("}")&&(s=JSON.parse(a))}catch{}if(s&&s.data&&s.data.results)for(let p=0;p<s.data.results.length;p++){let f=s.data.results[p].output;if(f){let b=f.text||"";e.messageType==f.messageType&&(K.value+=b,e.content=et(K.value))}}}},_t=e=>e.messageType=="user"?"pt-chat-message-item-content-user pt-flex-direction-rr":e.messageType=="assistant"?"pt-chat-message-item-content-assistant pt-flex":"",yt=e=>{if(e.target.classList.contains("pt-chat-code-container-header-content-right-copy")||e.target.classList.contains("pt-chat-code-container-footer-content-right-copy")){let t=e.target;for(;t&&!t.classList.contains("pt-chat-code-container");)t=t.parentElement;const n=t.querySelector("code");Dt(n.textContent,()=>{e.target.textContent="复制成功",setTimeout(()=>{e.target.textContent="复制"},1e3)},()=>{e.target.textContent="复制成功失败，请手动复制",setTimeout(()=>{e.target.textContent="复制"},1e3)})}};function xt(e,t){function n(a,s){if(a.classList&&a.className===s.className&&(a.classList.contains("pt-chat-code-container-header-content-right-copy")||a.classList.contains("pt-chat-code-container-footer-content-right-copy")))return;if(a&&a.nodeType===Node.TEXT_NODE&&s.nodeType===Node.TEXT_NODE){a.nodeValue!==s.nodeValue&&(a.nodeValue=s.nodeValue);return}if(!a||a.tagName!==s.tagName){const x=s.cloneNode(!0);a?a.parentNode.replaceChild(x,a):s.parentNode.appendChild(x);return}a.className!==s.className&&(a.className=s.className),a.id!==s.id&&(a.id=s.id),a.style.cssText!==s.style.cssText&&(a.style.cssText=s.style.cssText);const f=Array.from(a.childNodes),b=Array.from(s.childNodes);if(b.forEach((x,W)=>{const z=f[W];if(z)n(z,x);else{const Q=x.cloneNode(!0);a.appendChild(Q)}}),f.length>b.length)for(let x=b.length;x<f.length;x++)a.removeChild(f[x])}n(e,t)}const At={beforeMount(e,t,n){e.innerHTML=t.value},updated(e,t,n){const a=document.createElement("div");a.className="pt-chat-message-item-content-message",a.innerHTML=t.value,xt(e,a)}},Ct=()=>{let e={id:y.agiAgentId,chatId:Ht()};l.replace({path:"/admin/agiAgentChatPage",query:e})};return Mt(()=>{mt(y.agiAgentId),ht(y.chatId)}),(e,t)=>{const n=_("el-avatar"),a=_("el-button"),s=_("el-popover"),p=_("PtUpload"),f=_("PtLexicalEditorChatInput"),b=_("PtButton"),x=_("el-main"),W=_("el-container"),z=_("PtRouteViewPopover");return A(),I(Z,null,[r(W,{class:"pt-height-100-pc pt-width-100-pc"},{default:d(()=>[r(W,null,{default:d(()=>[r(x,{ref_key:"renderContainerRef",ref:C,onClick:yt,class:"pt-chat-message-main pt-flex-direction-c pt-flex-align-cross-center"},{default:d(()=>{var Q,ot;return[c("div",Gt,[c("div",Wt,[c("div",zt,[o.value&&o.value.data?(A(),X(n,{key:0,src:(Q=o.value)==null?void 0:Q.data.avatar},{default:d(()=>{var v,$;return[k(J((v=o.value)!=null&&v.data.name?(($=o.value)==null?void 0:$.data.name).substring(0,1):"AI"),1)]}),_:1},8,["src"])):N("",!0),c("span",Qt,J((ot=o.value)==null?void 0:ot.data.name),1)])]),t[4]||(t[4]=c("div",{class:"pt-chat-message-header-center"},"新对话",-1)),c("div",Xt,[c("div",Kt,[r(a,{type:"primary",link:"",icon:"ChatSquare",onClick:Ct},{default:d(()=>t[2]||(t[2]=[k("新建对话")])),_:1}),r(s,{placement:"bottom",width:"600",trigger:"click"},{reference:d(()=>[r(a,{type:"primary",link:"",icon:"Clock"},{default:d(()=>t[3]||(t[3]=[k("历史对话")])),_:1})]),default:d(()=>[o.value&&o.value.data?(A(),X(jt,{key:0,agiAgentId:o.value.data.id},null,8,["agiAgentId"])):N("",!0)]),_:1})])])]),c("div",Yt,[c("div",Zt,[(A(!0),I(Z,null,Nt(F.value,v=>{var $,rt;return A(),I("div",te,[c("div",{class:It(["pt-chat-message-item-content",_t(v)])},[c("div",ee,[v.messageType=="user"?(A(),X(n,{key:0,src:($=O(u).loginUser)==null?void 0:$.avatar},{default:d(()=>{var R,E,it,lt;return[k(J((R=O(u).loginUser)!=null&&R.nickname||(E=O(u).loginUser)!=null&&E.username?(((it=O(u).loginUser)==null?void 0:it.nickname)||((lt=O(u).loginUser)==null?void 0:lt.username)).substring(0,1):"我"),1)]}),_:1},8,["src"])):N("",!0),v.messageType=="assistant"?(A(),X(n,{key:1,src:(rt=o.value)==null?void 0:rt.data.avatar},{default:d(()=>{var R,E;return[k(J((R=o.value)!=null&&R.data.name?((E=o.value)==null?void 0:E.data.name).substring(0,1):"AI"),1)]}),_:1},8,["src"])):N("",!0)]),v.messageType=="user"?(A(),I("div",{key:0,class:"pt-chat-message-item-content-message",textContent:J(v.content)},null,8,ae)):N("",!0),v.messageType=="assistant"?St((A(),I("div",se,null,512)),[[At,v.content]]):N("",!0)],2)])}),256))])]),c("div",ne,[S.value?(A(),I("div",oe,[r(p,{drag:!0,"drag-tip":"将文件拖到此处，或<em>点击上传</em>"})])):N("",!0),r(f,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=v=>M.value=v),onEnter:ft},null,8,["modelValue"]),c("div",re,[t[8]||(t[8]=c("div",{class:"pt-chat-action-container-action-left pt-flex-align-cross-center"},null,-1)),c("div",ie,[r(b,{type:"default",icon:"MessageBox"},{default:d(()=>t[5]||(t[5]=[k("快捷指令")])),_:1}),r(b,{type:S.value?"primary":"default",icon:"Connection",onClick:t[1]||(t[1]=v=>S.value=!S.value)},{default:d(()=>t[6]||(t[6]=[k("上传附件")])),_:1},8,["type"]),r(b,{type:"primary",disabled:M.value.length<=0,loading:B.value,icon:"Position",onClick:st},{default:d(()=>t[7]||(t[7]=[k("发送")])),_:1},8,["disabled","loading"])])])])]}),_:1},512)]),_:1})]),_:1}),r(z,{level:3})],64)}}}),ue=Lt(le,[["__scopeId","data-v-6344b15c"]]);export{ue as default};
