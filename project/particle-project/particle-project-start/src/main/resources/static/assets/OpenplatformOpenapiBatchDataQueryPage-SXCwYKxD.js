import{e as V,f as S,g as q}from"./openplatformOpenapiCompItem-DhsNbVsI.js";import{a as E}from"./openplatformAppCompItem-BH6gzBAK.js";import{e as g,a as M,d as D}from"./FileTools-Cx4MUywI.js";import{d as G,r as f,a as W,b as r,o as F,c as O,e as l,w as c,f as K,I as L,F as z,E as j,aw as H,ax as J,ay as X,az as C,aA as Y}from"./index-BAoWe_iC.js";import{t as Z,d as $}from"./openplatformOpenapiBatchQueryRecordAdminApi-CshvUPGO.js";import"./openplatformAppAdminApi-Dc5MkXK0.js";import"./crmCompItem--npaq2f5.js";import"./crmCustomerTagAdminApi-DH7cQ09K.js";const ee={key:0},de=G({__name:"OpenplatformOpenapiBatchDataQueryPage",setup(te){let x=(e,t="success")=>{j({showClose:!0,message:e,type:t,showIcon:!0,grouping:!0})};const h=f(null),p=f(null),a=W({form:{},formComps:[E({label:"应用",required:!0,valueChange:({form:e,newValue:t})=>{t||(e.openplatformOpenapiId=null)},tips:" 1. 请先选择要使用的应用"}),V({fieldName:"openplatformOpenapiId",label:"开放接口",required:!0,disableGroup:!0,valueChange:({form:e,newValue:t})=>{},tips:" 2. 请选择要查询的接口"})],templateform:{},templateformComps:[{field:{name:"file",value:[]},element:{comp:"PtUpload",formItemProps:{label:"查询文件",required:!0,displayBlock:!0},compProps:{drag:!0,autoUpload:!1,limit:1,dragTip:"将文件拖到此处或<em>点击上传</em>",tipTxt:"只能上传一个文件，请严格按照下载的模板进行填写，并保证第一个sheet为查询参数",onExceed:(e,t)=>{x("最多只能选择一个文件,如要重新选择，请先删除之前的文件","error")}}}},{field:{name:"remark"},element:{comp:"el-input",formItemProps:{label:"备注",required:!0,displayBlock:!0},compProps:{clearable:!0}}}],openplatformOpenapiBatchQueryRecordId:null,tableColumns:Z,tableData:[]}),u=f({buttonText:"查询",loading:!1,permission:"admin:web:openplatformOpenapi:batchQuery"}),P=()=>{_(()=>{w(()=>{u.value.loading=!0,I().then(e=>{let t=e.data.data;a.openplatformOpenapiBatchQueryRecordId=t.id,k(a.openplatformOpenapiBatchQueryRecordId),x("查询成功,您可在当前页面刷新结果状态或稍候前往批量查询记录查看结果")}).finally(()=>{u.value.loading=!1})})}),w(()=>{})},_=e=>{h.value&&h.value.formRef.validate((t,o)=>{t&&e()})},w=e=>{p.value&&p.value.formRef.validate((t,o)=>{t&&e()})},I=()=>{let e=new FormData;for(let t in a.form)e.append(t,a.form[t]);return e.append("file",a.templateform.file[0].raw),e.append("remark",a.templateform.remark),q(e)},T=()=>{p.value&&p.value.resetForm()},b=f(!1),Q=()=>{_(()=>{b.value=!0;let e={};for(let t in a.form)e[t]=a.form[t];S(e).then(t=>{let o=t.data,m=g(t),n=M(t);n=decodeURIComponent(n),D(o,m,n)}).finally(()=>{b.value=!1})})},k=e=>{C(a.tableData),R(e).then(t=>{a.tableData=[t.data.data]})},N=e=>R(e).then(t=>{for(let o=0;o<a.tableData.length;o++)a.tableData[o].id==e&&Y(a.tableData,o,t.data.data);return Promise.resolve(t)}),R=e=>$({id:e}),U=({row:e,column:t,$index:o})=>{if(o<0)return[];e.id;let m={openplatformOpenapiBatchQueryRecordId:e.id};return[{txt:"刷新",text:!0,method(){return N(a.openplatformOpenapiBatchQueryRecordId)}},{txt:"下载",text:!0,disabled:e.executeStatusDictValue!="finished",disabledReason:e.executeStatusDictValue!="finished"?"执行完成后才可能下载":void 0,method(){let s=H(e.exportFileUrl),y=J(s);return X(s).then(i=>{let B=i.data,d=g(i),v=decodeURIComponent(y);return D(B,d,v),Promise.resolve(i)})}},{txt:"查看详情",text:!0,position:"more",permission:"admin:web:openplatformOpenapiBatchQueryRecordDetail:pageQuery",route:{path:"/admin/openplatformOpenapiBatchQueryRecordDetail1",query:m}},{txt:"删除",text:!0,position:"more",methodConfirmText:"确定要删除当前数据吗？删除后您可以前往批量查询记录查看结果",method(){a.openplatformOpenapiBatchQueryRecordId=null,C(a.tableData)}}]};return(e,t)=>{const o=r("PtForm"),m=r("PtButton"),n=r("PtButtonGroup"),s=r("el-table-column"),y=r("PtTable"),i=r("el-alert"),B=r("PtRouteViewPopover");return F(),O(z,null,[l(o,{ref_key:"formRef",ref:h,form:a.form,labelWidth:"120",defaultButtonsShow:"",inline:"",layout:2,comps:a.formComps},null,8,["form","comps"]),l(o,{ref_key:"templateFormRef",ref:p,form:a.templateform,labelWidth:"120",defaultButtonsShow:"",inline:"",layout:1,comps:a.templateformComps},null,8,["form","comps"]),l(o,{form:[],labelWidth:"120",method:P,defaultButtonsShow:"submit,reset",submitAttrs:u.value,inline:"",showButtonItem:!0,onResetForm:T,comps:[]},{buttons:c(()=>[l(m,{permission:"admin:web:openplatformOpenapi:batchQuery",loading:b.value,method:Q},{default:c(()=>t[1]||(t[1]=[K("下载模板")])),_:1},8,["loading"])]),_:1},8,["submitAttrs"]),a.openplatformOpenapiBatchQueryRecordId?(F(),O("div",ee,[l(y,{ref:"tableRef","default-expand-all":"",data:a.tableData,onDataMethodDataLoading:t[0]||(t[0]=d=>u.value.loading=d),columns:a.tableColumns},{defaultAppend:c(()=>[l(s,{label:"操作",width:"220"},{default:c(({row:d,column:v,$index:A})=>[l(n,{options:U({row:d,column:v,$index:A}),dropdownTriggerButtonOptions:{text:!0,buttonText:"更多"}},null,8,["options"])]),_:1})]),_:1},8,["data","columns"]),l(i,{title:"注意：以上表格仅展示最后一次查询的查询结果",type:"info",style:{width:"350px","margin-top":"10px"}})])):L("",!0),l(B,{level:3})],64)}}});export{de as default};
