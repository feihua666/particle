<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>particle-demo</title>
    <style>
        #container {
            width: 100%;
            height: 800px;
            overflow: hidden;
            margin: 0;
            padding: 0
        }
    </style>
</head>
<body>
<div id="container"></div>

    <script>
        const reactiveData = {map:null}
        const props = {
            initZoom: 14,
            // 地图初始坐标
            // 类型为数组[116.404, 39.915]
            initPoint: [116.404, 39.915],
            // 地图点击事件
            mClick:function () {

            },
            // 是否组件加载完毕自动初始化地图
            initAuto: true,
            // 百度申请的key
            ak: '69a5a1e7260cd2cd298c33666e436530'
        }
// 方法
// 初始化
const init = (BMapGL) => {
  if (reactiveData.map) {
    return
  }
  reactiveData.map = new BMapGL.Map('container')
  let point = newPoint(props.initPoint[0], props.initPoint[1])
  centerAndZoom(point, props.initZoom)
  let scaleControl = new BMapGL.ScaleControl({anchor: window.BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
  let zoomControl = new BMapGL.ZoomControl();  //左上角，添加默认缩放控件
  reactiveData.map.addControl(scaleControl);
  reactiveData.map.addControl(zoomControl);
  reactiveData.map.enableScrollWheelZoom(true);   //启用滚轮放大缩小，默认禁用
  reactiveData.map.enableContinuousZoom(true);    //启用地图惯性拖拽，默认禁用
  reactiveData.map.setDisplayOptions({
    poiText: true,
    poiIcon: true
  })
  bindClick()
  emit('ready', reactiveData.map)
}
// 地图脚本初始化
const bMapScript = (ak) => {
  // 感谢vue-baidu-map项目
  if (!window.BMapGL) {
    window.BMapGL = {}
    window.BMapGL._preloader = new Promise((resolve, reject) => {
      window._initBaiduMap = function () {
        resolve(window.BMapGL)
        window.document.body.removeChild($script)
        window.BMapGL._preloader = null
        window._initBaiduMap = null
      }
      const $script = document.createElement('script')
      window.document.body.appendChild($script)
      $script.src = `https://api.map.baidu.com/api?v=1.0&type=webgl&ak=${ak}&callback=_initBaiduMap`
    })
    return window.BMapGL._preloader
  } else if (!window.BMapGL._preloader) {
    return Promise.resolve(window.BMapGL)
  } else {
    return window.BMapGL._preloader
  }
}
const getMapIns = () => {
  return reactiveData.map
}
// 地图初始化完成后调用
const bindClick = () => {
  reactiveData.map.addEventListener('click', (e) => {
    props.mClick(e)
    emit('mClick', e)
  })
}
const centerAndZoom = (point, zoom)=> {
  reactiveData.map.centerAndZoom(point, zoom ? zoom : reactiveData.map.getZoom());
}
// 新建一个点
const newPoint = (longitude, latitude) => {
  let point = new window.BMapGL.Point(longitude, latitude)
  return point
}
// 新建一个geo定位器
const newGeocoder = () =>{
  let geo = new window.BMapGL.Geocoder()
  return geo
}
// 新建一个标注
const addMarker = (point) => {
  let marker = new window.BMapGL.Marker(point)
  reactiveData.map.addOverlay(marker);
}
const getPoint = (address, callback) => {
  // 创建地址解析器实例
  let myGeo = newGeocoder()
  // 将地址解析结果显示在地图上,并调整地图视野
  myGeo.getPoint(address, (point) => {
    callback(point)
  })
}
const getAddress = (point, callback) => {
  // 创建地址解析器实例
  let myGeo = newGeocoder()
  myGeo.getLocation(point, (rs) => {
    let addComp = rs.addressComponents
    let addr = []
    addr.push(addComp.province)
    addr.push(addComp.city)
    addr.push(addComp.street)
    addr.push(addComp.streetNumber)
    callback(addr, rs)
  })
}
// 地址解析并标注
const addressMarker = (address) => {
  getPoint(address, (point) => {
    if (point) {
      centerAndZoom(point,null)
      addMarker(point)
    }
  })
}
const clearOverlays = () => {
  reactiveData.map.clearOverlays()
}
const emit = () => {
}

  bMapScript('69a5a1e7260cd2cd298c33666e436530').then( (BMapGL)=> {
    if (props.initAuto === true) {
      init(BMapGL)
    } else {
      emit('ready',reactiveData.map)
    }
  })
    </script>
</body>
</html>